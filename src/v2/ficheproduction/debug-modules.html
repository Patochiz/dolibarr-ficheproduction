<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Correction FicheProduction v2.0</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        
        .test-container { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            margin-bottom: 20px; 
        }
        
        .debug-section { 
            border: 1px solid #ddd; 
            margin: 10px 0; 
            border-radius: 4px; 
            overflow: hidden; 
        }
        
        .debug-header { 
            background: #f8f9fa; 
            padding: 15px; 
            font-weight: bold; 
            border-bottom: 1px solid #ddd; 
        }
        
        .debug-content { 
            padding: 15px; 
        }
        
        .status-ok { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-error { color: #dc3545; }
        
        .console-output { 
            background: #1a1a1a; 
            color: #00ff00; 
            padding: 15px; 
            border-radius: 4px; 
            font-family: 'Courier New', monospace; 
            font-size: 12px; 
            max-height: 400px; 
            overflow-y: auto; 
            white-space: pre-wrap; 
        }
        
        .btn { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px; 
        }
        
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; }
        
        .file-status {
            padding: 8px;
            margin: 4px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .file-loaded { background: #d4edda; color: #155724; }
        .file-error { background: #f8d7da; color: #721c24; }
        .file-pending { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîß Debug - Correction FicheProduction v2.0</h1>
        <p>Diagnostic du probl√®me de chargement des modules</p>
        
        <!-- Status de chargement des fichiers -->
        <div class="debug-section">
            <div class="debug-header">üìÅ Status de Chargement des Fichiers</div>
            <div class="debug-content">
                <div id="files-status">V√©rification en cours...</div>
                <button class="btn" onclick="checkFileLoading()">üîç Rev√©rifier les Fichiers</button>
                <button class="btn btn-warning" onclick="loadFilesInline()">üîß Charger en Mode Debug</button>
            </div>
        </div>
        
        <!-- Console de debug -->
        <div class="debug-section">
            <div class="debug-header">üêõ Console de Debug</div>
            <div class="debug-content">
                <button class="btn" onclick="toggleDebugConsole()">üëÅÔ∏è Afficher/Masquer</button>
                <button class="btn" onclick="clearDebugConsole()">üßπ Nettoyer</button>
                <div id="debug-console-container">
                    <div id="debug-console-output" class="console-output"></div>
                </div>
            </div>
        </div>
        
        <!-- Diagnostic du namespace -->
        <div class="debug-section">
            <div class="debug-header">üìä Diagnostic du Namespace</div>
            <div class="debug-content">
                <div id="namespace-status">En attente...</div>
                <button class="btn" onclick="runDiagnostics()">üîç Lancer Diagnostics</button>
            </div>
        </div>
        
        <!-- Solution de fallback -->
        <div class="debug-section">
            <div class="debug-header">üöë Solution de Fallback</div>
            <div class="debug-content">
                <p>Si les fichiers ne se chargent pas, utilisez cette solution int√©gr√©e :</p>
                <button class="btn btn-success" onclick="createFallbackSolution()">üöÄ Cr√©er Solution Int√©gr√©e</button>
                <div id="fallback-status"></div>
            </div>
        </div>
    </div>

    <!-- Simulation de l'environnement -->
    <script>
        // Configuration de test
        window.ORDER_ID = 12345;
        window.TOKEN = 'test-token-123';
        
        // Capture des logs
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const debugLogs = [];
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            debugLogs.push(new Date().toLocaleTimeString() + ': ' + args.join(' '));
            updateDebugConsole();
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            debugLogs.push(new Date().toLocaleTimeString() + ': [ERROR] ' + args.join(' '));
            updateDebugConsole();
        };
        
        function updateDebugConsole() {
            const output = document.getElementById('debug-console-output');
            if (output) {
                output.textContent = debugLogs.join('\n');
                output.scrollTop = output.scrollHeight;
            }
        }
        
        function toggleDebugConsole() {
            const container = document.getElementById('debug-console-container');
            if (container.style.display === 'none') {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }
        
        function clearDebugConsole() {
            debugLogs.length = 0;
            updateDebugConsole();
        }
        
        // Liste des fichiers √† charger
        const expectedFiles = [
            'js/ficheproduction-core-fixed.js',
            'js/ficheproduction-inventory-fixed.js',
            'js/ficheproduction-colis-fixed.js',
            'js/ficheproduction-dragdrop-fixed.js',
            'js/ficheproduction-ui-fixed.js'
        ];
        
        function checkFileLoading() {
            console.log('üîç V√©rification du chargement des fichiers...');
            const statusDiv = document.getElementById('files-status');
            let html = '';
            
            expectedFiles.forEach(file => {
                // Cr√©er un √©l√©ment script temporaire pour tester
                const testScript = document.createElement('script');
                testScript.src = file;
                testScript.onload = function() {
                    console.log(`‚úÖ Fichier charg√©: ${file}`);
                };
                testScript.onerror = function() {
                    console.log(`‚ùå Erreur chargement: ${file}`);
                };
                
                // V√©rifier si le fichier existe d√©j√† dans le DOM
                const existingScript = document.querySelector(`script[src="${file}"]`);
                if (existingScript) {
                    html += `<div class="file-status file-loaded">‚úÖ ${file} - Pr√©sent dans le DOM</div>`;
                } else {
                    html += `<div class="file-status file-error">‚ùå ${file} - Pas trouv√© dans le DOM</div>`;
                }
            });
            
            // V√©rifier les variables globales
            html += '<br><strong>Variables Globales:</strong><br>';
            html += `<div class="file-status ${typeof window.FicheProduction !== 'undefined' ? 'file-loaded' : 'file-error'}">
                ${typeof window.FicheProduction !== 'undefined' ? '‚úÖ' : '‚ùå'} window.FicheProduction
            </div>`;
            html += `<div class="file-status ${typeof window.debugLog !== 'undefined' ? 'file-loaded' : 'file-error'}">
                ${typeof window.debugLog !== 'undefined' ? '‚úÖ' : '‚ùå'} window.debugLog
            </div>`;
            
            statusDiv.innerHTML = html;
        }
        
        function loadFilesInline() {
            console.log('üîß Chargement des fichiers en mode debug...');
            
            // Supprimer les anciens scripts
            expectedFiles.forEach(file => {
                const existingScript = document.querySelector(`script[src="${file}"]`);
                if (existingScript) {
                    existingScript.remove();
                }
            });
            
            // Charger les fichiers un par un avec gestion d'erreur
            loadFileSequentially(0);
        }
        
        function loadFileSequentially(index) {
            if (index >= expectedFiles.length) {
                console.log('üéâ Tous les fichiers ont √©t√© trait√©s');
                setTimeout(runDiagnostics, 500);
                return;
            }
            
            const file = expectedFiles[index];
            console.log(`üì• Tentative de chargement: ${file}`);
            
            const script = document.createElement('script');
            script.src = file;
            
            script.onload = function() {
                console.log(`‚úÖ Succ√®s: ${file}`);
                loadFileSequentially(index + 1);
            };
            
            script.onerror = function() {
                console.log(`‚ùå √âchec: ${file} - Fichier introuvable ou erreur de syntaxe`);
                loadFileSequentially(index + 1);
            };
            
            document.head.appendChild(script);
        }
        
        function runDiagnostics() {
            console.log('üîç D√©marrage des diagnostics...');
            const statusDiv = document.getElementById('namespace-status');
            
            // Test 1: V√©rifier que le namespace principal existe
            const hasMainNamespace = typeof window.FicheProduction !== 'undefined';
            console.log(`‚úì Namespace principal: ${hasMainNamespace ? '‚úÖ OK' : '‚ùå MANQUANT'}`);
            
            let html = `<div class="status-${hasMainNamespace ? 'ok' : 'error'}">
                ${hasMainNamespace ? '‚úÖ' : '‚ùå'} Namespace principal: ${hasMainNamespace ? 'OK' : 'MANQUANT'}
            </div>`;
            
            if (hasMainNamespace) {
                // Test 2: V√©rifier tous les modules
                const expectedModules = ['ajax', 'inventory', 'colis', 'dragdrop', 'ui', 'libre', 'utils'];
                expectedModules.forEach(moduleName => {
                    const hasModule = window.FicheProduction && window.FicheProduction[moduleName];
                    console.log(`‚úì Module ${moduleName}: ${hasModule ? '‚úÖ CHARG√â' : '‚ùå MANQUANT'}`);
                    html += `<div class="status-${hasModule ? 'ok' : 'error'}">
                        ${hasModule ? '‚úÖ' : '‚ùå'} Module ${moduleName}
                    </div>`;
                });
                
                // Test 3: V√©rifier les fonctions critiques
                const criticalFunctions = [
                    'FicheProduction.inventory.renderInventory',
                    'FicheProduction.colis.addNewColis',
                    'FicheProduction.dragdrop.setupDropZone',
                    'FicheProduction.ui.showConfirm'
                ];
                
                criticalFunctions.forEach(funcPath => {
                    const exists = checkFunctionExists(funcPath);
                    console.log(`‚úì Fonction ${funcPath}: ${exists ? '‚úÖ OK' : '‚ùå MANQUANT'}`);
                    html += `<div class="status-${exists ? 'ok' : 'error'}">
                        ${exists ? '‚úÖ' : '‚ùå'} ${funcPath}
                    </div>`;
                });
            }
            
            statusDiv.innerHTML = html;
            console.log('üéâ Diagnostics termin√©s');
        }
        
        function checkFunctionExists(path) {
            const parts = path.split('.');
            let current = window;
            
            for (let part of parts) {
                if (current && typeof current[part] !== 'undefined') {
                    current = current[part];
                } else {
                    return false;
                }
            }
            
            return typeof current === 'function';
        }
        
        function createFallbackSolution() {
            console.log('üöÄ Cr√©ation de la solution de fallback...');
            const statusDiv = document.getElementById('fallback-status');
            
            statusDiv.innerHTML = '<div class="status-warning">‚è≥ Cr√©ation en cours...</div>';
            
            // Cr√©er un namespace minimal
            window.FicheProduction = {
                data: {
                    products: () => [],
                    setProducts: (products) => { window.testProducts = products; },
                    productGroups: () => [],
                    setProductGroups: (groups) => { window.testGroups = groups; },
                    colis: () => [],
                    setColis: (colis) => { window.testColis = colis; },
                    selectedColis: () => null
                },
                inventory: {
                    renderInventory: function() {
                        console.log('üì¶ FALLBACK: renderInventory appel√©');
                        const container = document.getElementById('inventoryList');
                        if (container) {
                            container.innerHTML = '<div style="padding: 20px; background: #d4edda; border-radius: 4px;">‚úÖ FALLBACK: Fonction renderInventory op√©rationnelle!</div>';
                        }
                    }
                },
                colis: {
                    addNewColis: function() {
                        console.log('üì¶ FALLBACK: addNewColis appel√©');
                        alert('‚úÖ FALLBACK: Fonction addNewColis op√©rationnelle!');
                    }
                },
                dragdrop: {
                    setupDropZone: function() {
                        console.log('üéØ FALLBACK: setupDropZone appel√©');
                    }
                },
                ui: {
                    showConfirm: function(message) {
                        console.log('ü§î FALLBACK: showConfirm appel√©');
                        return Promise.resolve(confirm(message));
                    }
                }
            };
            
            // Cr√©er une interface de test
            const testInterface = document.createElement('div');
            testInterface.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px;">
                    <h3>üß™ Interface de Test Fallback</h3>
                    <button class="btn" onclick="FicheProduction.inventory.renderInventory()">Test renderInventory</button>
                    <button class="btn" onclick="FicheProduction.colis.addNewColis()">Test addNewColis</button>
                    <button class="btn" onclick="FicheProduction.ui.showConfirm('Test de confirmation')">Test showConfirm</button>
                    <div id="inventoryList" style="margin-top: 15px; min-height: 50px; border: 1px dashed #ccc; padding: 10px;"></div>
                </div>
            `;
            
            document.body.appendChild(testInterface);
            
            statusDiv.innerHTML = '<div class="status-ok">‚úÖ Solution de fallback cr√©√©e avec succ√®s!</div>';
            
            // Relancer les diagnostics
            setTimeout(runDiagnostics, 100);
        }
        
        // Initialisation automatique
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üì± DOM charg√© - D√©marrage du debug...');
            
            setTimeout(() => {
                checkFileLoading();
                runDiagnostics();
            }, 500);
        });
        
        console.log('üîß Script de debug charg√©');
    </script>
    
    <!-- Tentative de chargement des modules corrig√©s -->
    <script src="js/ficheproduction-core-fixed.js" onerror="console.error('Erreur chargement core-fixed.js')"></script>
    <script src="js/ficheproduction-inventory-fixed.js" onerror="console.error('Erreur chargement inventory-fixed.js')"></script>
    <script src="js/ficheproduction-colis-fixed.js" onerror="console.error('Erreur chargement colis-fixed.js')"></script>
    <script src="js/ficheproduction-dragdrop-fixed.js" onerror="console.error('Erreur chargement dragdrop-fixed.js')"></script>
    <script src="js/ficheproduction-ui-fixed.js" onerror="console.error('Erreur chargement ui-fixed.js')"></script>
</body>
</html>