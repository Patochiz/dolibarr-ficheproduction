<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test des Modules FicheProduction v2.0</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        
        .test-container { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            margin-bottom: 20px; 
        }
        
        .test-section { 
            border: 1px solid #ddd; 
            margin: 10px 0; 
            border-radius: 4px; 
            overflow: hidden; 
        }
        
        .test-header { 
            background: #f8f9fa; 
            padding: 15px; 
            font-weight: bold; 
            border-bottom: 1px solid #ddd; 
        }
        
        .test-content { 
            padding: 15px; 
        }
        
        .status-ok { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-error { color: #dc3545; }
        
        .module-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 15px; 
            margin: 10px 0; 
        }
        
        .module-card { 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            padding: 15px; 
            background: #f8f9fa; 
        }
        
        .console-output { 
            background: #1a1a1a; 
            color: #00ff00; 
            padding: 15px; 
            border-radius: 4px; 
            font-family: 'Courier New', monospace; 
            font-size: 12px; 
            max-height: 400px; 
            overflow-y: auto; 
            white-space: pre-wrap; 
        }
        
        .btn { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px; 
        }
        
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Test des Modules FicheProduction v2.0</h1>
        <p>Diagnostic complet de l'architecture modulaire restructur√©e</p>
        
        <!-- Status global -->
        <div class="test-section">
            <div class="test-header">üìä Status Global</div>
            <div class="test-content">
                <div id="global-status">Chargement en cours...</div>
            </div>
        </div>
        
        <!-- Modules charg√©s -->
        <div class="test-section">
            <div class="test-header">üì¶ Modules Charg√©s</div>
            <div class="test-content">
                <div id="modules-status" class="module-list">
                    <!-- G√©n√©r√© par JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Tests fonctionnels -->
        <div class="test-section">
            <div class="test-header">‚ö° Tests Fonctionnels</div>
            <div class="test-content">
                <button class="btn" onclick="testBasicFunctions()">üîß Tester Fonctions de Base</button>
                <button class="btn btn-success" onclick="testModuleIntegration()">üîó Tester Int√©gration</button>
                <button class="btn btn-warning" onclick="testErrorHandling()">‚ö†Ô∏è Tester Gestion d'Erreurs</button>
                <button class="btn btn-danger" onclick="clearTests()">üóëÔ∏è Nettoyer</button>
                <div id="functional-tests-results"></div>
            </div>
        </div>
        
        <!-- Console de debug -->
        <div class="test-section">
            <div class="test-header">üêõ Console de Debug</div>
            <div class="test-content">
                <button class="btn" onclick="toggleDebugConsole()">üëÅÔ∏è Afficher/Masquer Console</button>
                <button class="btn" onclick="clearDebugConsole()">üßπ Nettoyer Console</button>
                <div id="debug-console-container" style="display: none;">
                    <div id="debug-console-output" class="console-output"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chargement des modules dans l'ordre correct -->
    <script>
        // Simulation de l'environnement Dolibarr pour les tests
        window.ORDER_ID = 12345;
        window.TOKEN = 'test-token-123';
        
        // Capture de tous les logs pour la console de debug
        const originalConsoleLog = console.log;
        const debugLogs = [];
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            debugLogs.push(args.join(' '));
            updateDebugConsole();
        };
        
        function updateDebugConsole() {
            const output = document.getElementById('debug-console-output');
            if (output) {
                output.textContent = debugLogs.join('\n');
                output.scrollTop = output.scrollHeight;
            }
        }
        
        function toggleDebugConsole() {
            const container = document.getElementById('debug-console-container');
            container.style.display = container.style.display === 'none' ? 'block' : 'none';
        }
        
        function clearDebugConsole() {
            debugLogs.length = 0;
            updateDebugConsole();
        }
    </script>
    
    <!-- Core module (doit √™tre charg√© en premier) -->
    <script src="js/ficheproduction-core.js"></script>
    <script src="js/ficheproduction-utils.js"></script>
    <script src="js/ficheproduction-ajax.js"></script>
    <script src="js/ficheproduction-inventory.js"></script>
    <script src="js/ficheproduction-colis.js"></script>
    <script src="js/ficheproduction-dragdrop.js"></script>
    <script src="js/ficheproduction-ui.js"></script>
    <script src="js/ficheproduction-libre.js"></script>

    <script>
        // ============================================================================
        // TESTS ET DIAGNOSTICS
        // ============================================================================
        
        function runDiagnostics() {
            console.log('üîç D√©marrage des diagnostics...');
            
            // Test 1: V√©rifier que le namespace principal existe
            const hasMainNamespace = typeof window.FicheProduction !== 'undefined';
            console.log(`‚úì Namespace principal: ${hasMainNamespace ? '‚úÖ OK' : '‚ùå MANQUANT'}`);
            
            // Test 2: V√©rifier tous les modules
            const expectedModules = ['ajax', 'inventory', 'colis', 'dragdrop', 'ui', 'libre', 'utils'];
            const loadedModules = [];
            const missingModules = [];
            
            expectedModules.forEach(moduleName => {
                if (window.FicheProduction && window.FicheProduction[moduleName]) {
                    loadedModules.push(moduleName);
                    console.log(`‚úì Module ${moduleName}: ‚úÖ CHARG√â`);
                } else {
                    missingModules.push(moduleName);
                    console.log(`‚úì Module ${moduleName}: ‚ùå MANQUANT`);
                }
            });
            
            // Test 3: V√©rifier les fonctions critiques
            const criticalFunctions = [
                'FicheProduction.ajax.loadData',
                'FicheProduction.inventory.renderInventory',
                'FicheProduction.colis.addNewColis',
                'FicheProduction.ui.showConfirm',
                'FicheProduction.dragdrop.setupDropZone'
            ];
            
            criticalFunctions.forEach(funcPath => {
                const exists = checkFunctionExists(funcPath);
                console.log(`‚úì Fonction ${funcPath}: ${exists ? '‚úÖ OK' : '‚ùå MANQUANT'}`);
            });
            
            // Mettre √† jour l'interface
            updateDiagnosticsDisplay(loadedModules, missingModules);
            
            console.log('üéâ Diagnostics termin√©s');
        }
        
        function checkFunctionExists(path) {
            const parts = path.split('.');
            let current = window;
            
            for (let part of parts) {
                if (current && typeof current[part] !== 'undefined') {
                    current = current[part];
                } else {
                    return false;
                }
            }
            
            return typeof current === 'function';
        }
        
        function updateDiagnosticsDisplay(loadedModules, missingModules) {
            // Status global
            const globalStatus = document.getElementById('global-status');
            if (missingModules.length === 0) {
                globalStatus.innerHTML = '<span class="status-ok">‚úÖ Tous les modules sont charg√©s correctement</span>';
            } else {
                globalStatus.innerHTML = `<span class="status-error">‚ùå ${missingModules.length} module(s) manquant(s): ${missingModules.join(', ')}</span>`;
            }
            
            // Modules status
            const modulesContainer = document.getElementById('modules-status');
            const allModules = ['core', 'ajax', 'inventory', 'colis', 'dragdrop', 'ui', 'libre', 'utils'];
            
            modulesContainer.innerHTML = allModules.map(module => {
                const isLoaded = module === 'core' || loadedModules.includes(module);
                const status = isLoaded ? 'status-ok' : 'status-error';
                const icon = isLoaded ? '‚úÖ' : '‚ùå';
                
                return `
                    <div class="module-card">
                        <strong class="${status}">${icon} ${module}</strong>
                        <div style="font-size: 12px; margin-top: 5px;">
                            ${isLoaded ? 'Module charg√© et op√©rationnel' : 'Module manquant ou d√©faillant'}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function testBasicFunctions() {
            console.log('üß™ Test des fonctions de base...');
            const results = document.getElementById('functional-tests-results');
            let html = '<h4>R√©sultats des tests:</h4>';
            
            try {
                // Test 1: Cr√©ation d'un colis
                if (window.FicheProduction && window.FicheProduction.colis) {
                    console.log('‚úì Test cr√©ation colis...');
                    html += '<p class="status-ok">‚úÖ Module colis accessible</p>';
                } else {
                    html += '<p class="status-error">‚ùå Module colis non accessible</p>';
                }
                
                // Test 2: Interface utilisateur
                if (window.FicheProduction && window.FicheProduction.ui) {
                    console.log('‚úì Test interface utilisateur...');
                    html += '<p class="status-ok">‚úÖ Module UI accessible</p>';
                } else {
                    html += '<p class="status-error">‚ùå Module UI non accessible</p>';
                }
                
                // Test 3: Configuration
                if (window.FicheProduction && window.FicheProduction.config) {
                    FicheProduction.config.setConfig(12345, 'test-token');
                    const orderId = FicheProduction.config.orderId();
                    const token = FicheProduction.config.token();
                    
                    html += `<p class="status-ok">‚úÖ Configuration OK (Order: ${orderId}, Token: ${token ? 'D√©fini' : 'Manquant'})</p>`;
                } else {
                    html += '<p class="status-error">‚ùå Configuration non accessible</p>';
                }
                
            } catch (error) {
                html += `<p class="status-error">‚ùå Erreur pendant les tests: ${error.message}</p>`;
                console.error('Erreur test:', error);
            }
            
            results.innerHTML = html;
        }
        
        function testModuleIntegration() {
            console.log('üîó Test d\'int√©gration des modules...');
            const results = document.getElementById('functional-tests-results');
            let html = '<h4>Tests d\'int√©gration:</h4>';
            
            try {
                // Test d'initialisation compl√®te
                if (typeof initializeFicheProduction === 'function') {
                    html += '<p class="status-ok">‚úÖ Fonction d\'initialisation principale disponible</p>';
                    
                    // Simuler l'initialisation
                    console.log('Simulation de l\'initialisation...');
                    html += '<p class="status-warning">‚ö†Ô∏è Initialisation simul√©e (mode test)</p>';
                } else {
                    html += '<p class="status-error">‚ùå Fonction d\'initialisation manquante</p>';
                }
                
            } catch (error) {
                html += `<p class="status-error">‚ùå Erreur int√©gration: ${error.message}</p>`;
                console.error('Erreur int√©gration:', error);
            }
            
            results.innerHTML = html;
        }
        
        function testErrorHandling() {
            console.log('‚ö†Ô∏è Test de gestion d\'erreurs...');
            const results = document.getElementById('functional-tests-results');
            let html = '<h4>Tests de gestion d\'erreurs:</h4>';
            
            try {
                // Test d'erreur contr√¥l√©e
                if (window.FicheProduction && window.FicheProduction.ui && window.FicheProduction.ui.showToast) {
                    FicheProduction.ui.showToast('Test de notification', 'info', 2000);
                    html += '<p class="status-ok">‚úÖ Syst√®me de notifications op√©rationnel</p>';
                } else {
                    html += '<p class="status-warning">‚ö†Ô∏è Syst√®me de notifications non disponible</p>';
                }
                
                // Test de log de debug
                if (typeof debugLog === 'function') {
                    debugLog('Test de debug log depuis les tests');
                    html += '<p class="status-ok">‚úÖ Syst√®me de debug op√©rationnel</p>';
                } else {
                    html += '<p class="status-error">‚ùå Syst√®me de debug non disponible</p>';
                }
                
            } catch (error) {
                html += `<p class="status-error">‚ùå Erreur lors des tests d'erreur: ${error.message}</p>`;
                console.error('Erreur test erreurs:', error);
            }
            
            results.innerHTML = html;
        }
        
        function clearTests() {
            document.getElementById('functional-tests-results').innerHTML = '';
            console.log('üóëÔ∏è Tests nettoy√©s');
        }
        
        // Lancer les diagnostics au chargement
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(runDiagnostics, 100); // Petit d√©lai pour s'assurer que tous les modules sont charg√©s
        });
    </script>
</body>
</html>